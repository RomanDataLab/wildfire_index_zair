<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="Interactive wildfire risk map for the Democratic Republic of the Congo (DRC) showing terrain slope (DEM), fire weather, vegetation index, population, and historical fires">
    <meta name="keywords" content="DRC, Democratic Republic of Congo, wildfire, fire risk, terrain slope, DEM, digital elevation model, map, interactive">
    <title>DRC Wildfire Risk Map - Terrain Slope (DEM) & Fire Index</title>
    
    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
    
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            left: 0;
        }
        .leaflet-container { 
            font-size: 1rem; 
        }
        .leaflet-image-layer {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: -o-crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
        }
        /* Vertical slider styling */
        #opacity-slider {
            writing-mode: bt-lr; /* IE */
            -webkit-appearance: slider-vertical; /* WebKit */
            width: 20px;
            height: 200px;
            margin: 0;
            cursor: pointer;
            background: transparent;
        }
        #opacity-slider::-webkit-slider-runnable-track {
            width: 20px;
            height: 200px;
            background: linear-gradient(to bottom, #d73027 0%, #f46d43 50%, #fee08b 100%);
            border-radius: 3px;
        }
        #opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #333;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-left: -2px;
        }
        #opacity-slider::-moz-range-track {
            width: 20px;
            height: 200px;
            background: linear-gradient(to bottom, #d73027 0%, #f46d43 50%, #fee08b 100%);
            border-radius: 3px;
        }
        #opacity-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #333;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #opacity-slider::-ms-track {
            width: 20px;
            height: 200px;
            background: transparent;
            border-color: transparent;
            color: transparent;
        }
        #opacity-slider::-ms-thumb {
            width: 24px;
            height: 24px;
            background: #333;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #fff;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
    
    <!-- Layer Control Panel -->
    <div id="layer-control-panel" style="position: fixed; 
                top: 50%; right: 20px; transform: translateY(-50%);
                width: 220px; z-index:9999; 
                background-color: white; 
                border:2px solid #333; border-radius: 5px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.4); 
                font-family: Arial, sans-serif;
                padding: 12px; height: 280px; overflow-y: auto;">
        <h4 style="margin-top:0; margin-bottom:12px; text-align:center; font-size:14px; font-weight:bold; color: #333;">Map Layers</h4>
        <div id="layer-buttons" style="display: flex; flex-direction: column; gap: 6px;">
            <button id="btn-wildfire-index" onclick="toggleLayer('wildfire_index')" 
                    style="padding: 8px; background-color: #666; color: white; 
                           border: none; border-radius: 3px; cursor: pointer; 
                           font-size: 12px; text-align: left;">
                üî• Wildfire Index
            </button>
            <button id="btn-historical-fires" onclick="toggleLayer('historical_fires')" 
                    style="padding: 8px; background-color: #666; color: white; 
                           border: none; border-radius: 3px; cursor: pointer; 
                           font-size: 12px; text-align: left;">
                üî• Historical Fires
            </button>
            <button id="btn-fire-weather-lst" onclick="toggleLayer('fire_weather_lst')" 
                    style="padding: 8px; background-color: #666; color: white; 
                           border: none; border-radius: 3px; cursor: pointer; 
                           font-size: 12px; text-align: left;">
                üå°Ô∏è Fire Weather (LST)
            </button>
            <button id="btn-vegetation-ndvi" onclick="toggleLayer('vegetation_ndvi')" 
                    style="padding: 8px; background-color: #666; color: white; 
                           border: none; border-radius: 3px; cursor: pointer; 
                           font-size: 12px; text-align: left;">
                üåø Vegetation (NDVI)
            </button>
            <button id="btn-population-urban" onclick="toggleLayer('population_urban')" 
                    style="padding: 8px; background-color: #666; color: white; 
                           border: none; border-radius: 3px; cursor: pointer; 
                           font-size: 12px; text-align: left;">
                üèôÔ∏è Population/Urban
            </button>
            <button id="btn-terrain-slope" onclick="toggleLayer('terrain_slope')" 
                    style="padding: 8px; background-color: #d73027; color: white; 
                           border: none; border-radius: 3px; cursor: pointer; 
                           font-size: 12px; text-align: left; font-weight: bold;">
                ‚õ∞Ô∏è Terrain Slope (DEM)
            </button>
            <button id="btn-methodology" onclick="window.open('/methodology.html', '_blank')" 
                    style="padding: 8px; background-color: white; color: #666; 
                           border: 1px solid #ccc; border-radius: 3px; cursor: pointer; 
                           font-size: 12px; text-align: left; margin-top: 0px;">
                Methodology
            </button>
        </div>
    </div>
    
    <!-- Map Title -->
    <div style="position: fixed; top: 10px; left: 50px; width: auto; height: auto;
                background-color: white; z-index: 1000; font-size: 16px;
                padding: 8px 16px; border: 2px solid #333; border-radius: 3px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); font-weight: bold;
                font-family: Arial, sans-serif;">
        Democratic Republic of the Congo - Wildfire Risk Map
    </div>
    
    <!-- Legend -->
    <div id="map-legend" style="position: fixed; top: 50%; right: 270px;
                transform: translateY(-50%); width: 130px; height: 280px;
                background-color: white; z-index: 1000; font-size: 12px;
                padding: 12px; border: 2px solid #333; border-radius: 3px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4); font-family: Arial, sans-serif;">
        <h4 id="legend-title" style="margin-top: 0; margin-bottom: 10px; text-align: center;
                font-size: 14px; font-weight: bold; color: #333;">Terrain Slope (DEM)</h4>
        <div style="display: flex; align-items: center; height: 220px;">
            <!-- Opacity Slider -->
            <div style="display: flex; flex-direction: column; align-items: center; margin-right: 8px; height: 100%;">
                <input type="range" id="opacity-slider" min="0" max="100" value="90" 
                       orient="vertical" 
                       oninput="updateOpacity(this.value)">
                <div style="display: flex; flex-direction: column; justify-content: space-between;
                            height: 200px; margin-top: 5px; font-size: 9px; color: #666; text-align: center;">
                    <span>100%</span>
                    <span>0%</span>
                </div>
            </div>
            <!-- Gradient Bar -->
            <div style="height: 220px; width: 35px; position: relative;">
                <div id="gradient-bar" style="height: 100%; width: 100%; border: 2px solid #000;
                        background: linear-gradient(to top, #006837, #238443, #41ab5d, #78c679, 
                        #addd8e, #d9f0a3, #f7fcb9, #fee08b, #fdae61, #f46d43, #d73027, #a50026);">
                </div>
            </div>
            <!-- Labels -->
            <div style="display: flex; flex-direction: column; justify-content: space-between;
                        height: 220px; padding-left: 5px;">
                <span style="font-size: 11px; font-weight: bold;">Low</span>
                <span style="font-size: 11px; font-weight: bold;">High</span>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <script>
    // DRC bounds from GeoJSON (same as React component)
    const GEOJSON_BOUNDS = [
        [-13.4538086000, 12.2136719000],  // Southwest [lat, lon]
        [5.3121094000, 31.2740234000]     // Northeast [lat, lon]
    ];
    
    // Center of DRC
    const CENTER = [
        (GEOJSON_BOUNDS[0][0] + GEOJSON_BOUNDS[1][0]) / 2,
        (GEOJSON_BOUNDS[0][1] + GEOJSON_BOUNDS[1][1]) / 2
    ];
    
    // Layer configurations
    // In Vite, public folder files are served from root, so use absolute paths
    const LAYERS = {
        'wildfire_index': {
            url: '/wildfire_intensity_overlay.png',
            bounds: GEOJSON_BOUNDS,
            opacity: 0.0,
            visible: false,
            name: 'Wildfire Index',
            palette: ['#ffffcc', '#ffeda0', '#fed976', '#feb24c', '#fd8d3c', '#fc4e2a', '#e31a1c', '#bd0026', '#800026']
        },
        'historical_fires': {
            url: '/component_maps/historical_fires_overlay.png',
            bounds: GEOJSON_BOUNDS,
            opacity: 0.0,
            visible: false,
            name: 'Historical Fires',
            palette: ['#fff7ec', '#fee8c8', '#fdd49e', '#fdbb84', '#fc8d59', '#ef6548', '#d7301f', '#b30000', '#7f0000']
        },
        'fire_weather_lst': {
            url: '/component_maps/fire_weather_(lst)_overlay.png',
            bounds: GEOJSON_BOUNDS,
            opacity: 0.0,
            visible: false,
            name: 'Fire Weather (LST)',
            palette: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffcc', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']
        },
        'vegetation_ndvi': {
            url: '/component_maps/vegetation_index_(ndvi)_overlay.png',
            bounds: GEOJSON_BOUNDS,
            opacity: 0.0,
            visible: false,
            name: 'Vegetation Index (NDVI)',
            palette: ['#8b4513', '#a0522d', '#cd853f', '#daa520', '#9acd32', '#7cfc00', '#32cd32', '#228b22', '#006400']
        },
        'population_urban': {
            url: '/component_maps/population_urban_overlay.png',
            bounds: GEOJSON_BOUNDS,
            opacity: 0.0,
            visible: false,
            name: 'Population/Urban',
            palette: ['#f7f7f7', '#d9d9d9', '#bdbdbd', '#969696', '#737373', '#525252', '#252525', '#000000']
        },
        'terrain_slope': {
            url: '/component_maps/terrain_slope_overlay.png',
            bounds: GEOJSON_BOUNDS,
            opacity: 0.9,
            visible: true,
            name: 'Terrain Slope (DEM)',
            palette: ['#006837', '#238443', '#41ab5d', '#78c679', '#addd8e', '#d9f0a3', '#f7fcb9', '#fee08b', '#fdae61', '#f46d43', '#d73027', '#a50026']
        }
    };
    
    var map = null;
    var imageOverlays = {};
    var activeLayer = 'terrain_slope';
    
    // Initialize map
    function initMap() {
        map = L.map('map', {
            center: CENTER,
            zoom: 6,
            scrollWheelZoom: true,
            doubleClickZoom: true
        });
        
        // Add base tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Add all image overlays
        for (var layerId in LAYERS) {
            var layerConfig = LAYERS[layerId];
            var overlay = L.imageOverlay(
                layerConfig.url,
                layerConfig.bounds,
                {
                    opacity: layerConfig.opacity,
                    interactive: false
                }
            );
            imageOverlays[layerId] = overlay;
            
            if (layerConfig.visible) {
                overlay.addTo(map);
            }
        }
        
        // Load and add DRC boundary
        // In Vite, public folder files are served from root
        fetch('/drc_admin_wei.geojson')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                // Check if response is actually JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Try to parse as text first to see what we got
                    return response.text().then(text => {
                        console.log('Response text:', text.substring(0, 100));
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            throw new Error('Response is not valid JSON');
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                if (!data || !data.features) {
                    console.error('Invalid GeoJSON data:', data);
                    return;
                }
                L.geoJSON(data, {
                    style: {
                        fillColor: 'none',
                        color: '#000000',
                        weight: 2,
                        opacity: 1.0,
                        fillOpacity: 0
                    }
                }).addTo(map);
            })
            .catch(error => {
                console.error('Error loading GeoJSON:', error);
                // Continue without boundary if it fails
            });
        
        // Fit bounds to DRC
        map.fitBounds(GEOJSON_BOUNDS, { padding: [20, 20] });
    }
    
    // Toggle layer visibility - only one layer active at a time
    function toggleLayer(layerId) {
        var layerConfig = LAYERS[layerId];
        var overlay = imageOverlays[layerId];
        var button = document.getElementById('btn-' + layerId.replace(/_/g, '-'));
        
        if (!overlay) {
            console.error('Layer not found: ' + layerId);
            return;
        }
        
        // If clicking the same layer that's already on, turn it off and show terrain_slope as default
        if (layerConfig.visible && activeLayer === layerId) {
            // Turn off current layer
            layerConfig.visible = false;
            layerConfig.opacity = 0.0;
            overlay.setOpacity(0.0);
            
            // Turn on terrain_slope as default
            var terrainConfig = LAYERS['terrain_slope'];
            var terrainOverlay = imageOverlays['terrain_slope'];
            if (terrainOverlay) {
                terrainConfig.visible = true;
                // Keep existing opacity or set to 0.9 if it was 0
                if (terrainConfig.opacity === 0.0) {
                    terrainConfig.opacity = 0.9;
                }
                terrainOverlay.addTo(map);
                terrainOverlay.setOpacity(terrainConfig.opacity);
                activeLayer = 'terrain_slope';
                updateLegend('terrain_slope');
                var terrainButton = document.getElementById('btn-terrain-slope');
                if (terrainButton) {
                    terrainButton.style.backgroundColor = '#d73027';
                    terrainButton.style.fontWeight = 'bold';
                }
            }
            
            // Update button style
            if (button) {
                button.style.backgroundColor = '#666';
                button.style.fontWeight = 'normal';
            }
            return;
        }
        
        // Turn off all other layers first
        for (var id in LAYERS) {
            if (id !== layerId && LAYERS[id].visible) {
                var otherOverlay = imageOverlays[id];
                if (otherOverlay) {
                    otherOverlay.setOpacity(0.0);
                    LAYERS[id].visible = false;
                    var otherButton = document.getElementById('btn-' + id.replace(/_/g, '-'));
                    if (otherButton) {
                        otherButton.style.backgroundColor = '#666';
                        otherButton.style.fontWeight = 'normal';
                    }
                }
            }
        }
        
        // Turn on the selected layer
        layerConfig.visible = true;
        // Keep existing opacity or set to 0.9 if it was 0
        if (layerConfig.opacity === 0.0) {
            layerConfig.opacity = 0.9;
        }
        overlay.addTo(map);
        overlay.setOpacity(layerConfig.opacity);
        activeLayer = layerId;
        updateLegend(layerId);
        
        // Update button style
        if (button) {
            button.style.backgroundColor = '#d73027';
            button.style.fontWeight = 'bold';
        }
    }
    
    // Update legend
    function updateLegend(layerId) {
        var layerConfig = LAYERS[layerId];
        if (!layerConfig) return;
        
        var legend = document.getElementById('map-legend');
        var title = document.getElementById('legend-title');
        var gradient = document.getElementById('gradient-bar');
        var slider = document.getElementById('opacity-slider');
        
        if (legend && title && gradient) {
            legend.style.display = 'block';
            title.textContent = layerConfig.name;
            gradient.style.background = 'linear-gradient(to top, ' + layerConfig.palette.join(', ') + ')';
        }
        
        // Update slider to match current opacity
        if (slider && layerConfig) {
            slider.value = Math.round(layerConfig.opacity * 100);
        }
    }
    
    // Update opacity of active layer
    function updateOpacity(value) {
        var opacity = parseFloat(value) / 100.0;
        var overlay = imageOverlays[activeLayer];
        var layerConfig = LAYERS[activeLayer];
        
        if (overlay && layerConfig) {
            overlay.setOpacity(opacity);
            layerConfig.opacity = opacity;
        }
    }
    
    // Initialize when page loads
    window.addEventListener('load', function() {
        initMap();
        updateLegend('terrain_slope');
    });
    </script>
</body>
</html>



